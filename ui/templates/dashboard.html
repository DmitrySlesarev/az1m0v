<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Dashboard - az1m0v</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background-color: #4CAF50;
        }

        .status-indicator.disconnected {
            background-color: #f44336;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .card h2 {
            font-size: 1.5em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            opacity: 0.9;
        }

        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .metric-unit {
            font-size: 0.8em;
            opacity: 0.7;
            margin-left: 5px;
        }

        .battery-soc {
            width: 100%;
            height: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .battery-soc-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 50%, #FFC107 25%, #FF9800 75%, #f44336 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }

        .state-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .state-parked { background-color: #9E9E9E; }
        .state-ready { background-color: #4CAF50; }
        .state-driving { background-color: #2196F3; }
        .state-charging { background-color: #FF9800; }
        .state-error { background-color: #f44336; }
        .state-emergency { background-color: #f44336; animation: blink 1s infinite; }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .can-stats {
            font-size: 0.9em;
        }

        .can-stats .metric-value {
            font-size: 1em;
        }

        .timestamp {
            text-align: center;
            margin-top: 20px;
            opacity: 0.7;
            font-size: 0.9em;
        }

        .temp-warning {
            color: #FFC107;
            font-weight: bold;
        }

        .temp-fault {
            color: #f44336;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        .temp-normal {
            color: #4CAF50;
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° EV Management Dashboard</h1>
            <p>
                <span class="status-indicator disconnected" id="statusIndicator"></span>
                <span id="connectionStatus">Disconnected</span>
            </p>
        </header>

        <div class="dashboard-grid">
            <!-- Battery Card -->
            <div class="card">
                <h2>üîã Battery</h2>
                <div class="metric">
                    <span class="metric-label">Voltage</span>
                    <span class="metric-value">
                        <span id="battery-voltage">--</span>
                        <span class="metric-unit">V</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Current</span>
                    <span class="metric-value">
                        <span id="battery-current">--</span>
                        <span class="metric-unit">A</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Temperature</span>
                    <span class="metric-value">
                        <span id="battery-temperature">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">State of Charge</span>
                    <span class="metric-value">
                        <span id="battery-soc-value">--</span>
                        <span class="metric-unit">%</span>
                    </span>
                </div>
                <div class="battery-soc">
                    <div class="battery-soc-fill" id="battery-soc-bar" style="width: 0%">
                        <span id="battery-soc-text">0%</span>
                    </div>
                </div>
            </div>

            <!-- Motor Card -->
            <div class="card">
                <h2>‚öôÔ∏è Motor</h2>
                <div class="metric">
                    <span class="metric-label">Speed</span>
                    <span class="metric-value">
                        <span id="motor-speed">--</span>
                        <span class="metric-unit">RPM</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Torque</span>
                    <span class="metric-value">
                        <span id="motor-torque">--</span>
                        <span class="metric-unit">Nm</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Temperature</span>
                    <span class="metric-value">
                        <span id="motor-temperature">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
            </div>

            <!-- Charging Card -->
            <div class="card">
                <h2>üîå Charging</h2>
                <div class="metric">
                    <span class="metric-label">Voltage</span>
                    <span class="metric-value">
                        <span id="charger-voltage">--</span>
                        <span class="metric-unit">V</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Current</span>
                    <span class="metric-value">
                        <span id="charger-current">--</span>
                        <span class="metric-unit">A</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">State</span>
                    <span class="metric-value">
                        <span class="state-badge" id="charger-state">--</span>
                    </span>
                </div>
            </div>

            <!-- Vehicle Card -->
            <div class="card">
                <h2>üöó Vehicle</h2>
                <div class="metric">
                    <span class="metric-label">State</span>
                    <span class="metric-value">
                        <span class="state-badge" id="vehicle-state">--</span>
                    </span>
                </div>
            </div>

            <!-- Temperature Sensors Card -->
            <div class="card">
                <h2>üå°Ô∏è Temperature Sensors</h2>
                <div class="metric">
                    <span class="metric-label">Battery Cell Groups</span>
                    <span class="metric-value">
                        <span id="temp-battery-groups">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Coolant Inlet</span>
                    <span class="metric-value">
                        <span id="temp-coolant-inlet">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Coolant Outlet</span>
                    <span class="metric-value">
                        <span id="temp-coolant-outlet">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Motor Stator</span>
                    <span class="metric-value">
                        <span id="temp-motor-stator">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Charging Port</span>
                    <span class="metric-value">
                        <span id="temp-charging-port">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Charging Connector</span>
                    <span class="metric-value">
                        <span id="temp-charging-connector">--</span>
                        <span class="metric-unit">¬∞C</span>
                    </span>
                </div>
            </div>

            <!-- CAN Bus Stats Card -->
            <div class="card">
                <h2>üì° CAN Bus</h2>
                <div class="can-stats">
                    <div class="metric">
                        <span class="metric-label">Frames Sent</span>
                        <span class="metric-value" id="can-frames-sent">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Frames Received</span>
                        <span class="metric-value" id="can-frames-received">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Errors</span>
                        <span class="metric-value" id="can-errors">0</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Connected</span>
                        <span class="metric-value">
                            <span id="can-connected">No</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="timestamp">
            Last Update: <span id="last-update">Never</span>
        </div>
    </div>

    <script>
        // Connect to WebSocket server
        const socket = io();

        const statusIndicator = document.getElementById('statusIndicator');
        const connectionStatus = document.getElementById('connectionStatus');

        // Connection status
        socket.on('connect', () => {
            statusIndicator.classList.remove('disconnected');
            statusIndicator.classList.add('connected');
            connectionStatus.textContent = 'Connected';
            console.log('Connected to dashboard server');
        });

        socket.on('disconnect', () => {
            statusIndicator.classList.remove('connected');
            statusIndicator.classList.add('disconnected');
            connectionStatus.textContent = 'Disconnected';
            console.log('Disconnected from dashboard server');
        });

        // Handle data updates
        socket.on('data_update', (data) => {
            console.log('Data update received:', data);

            // Update battery data
            if (data.battery) {
                updateElement('battery-voltage', data.battery.voltage);
                updateElement('battery-current', data.battery.current);
                updateElement('battery-temperature', data.battery.temperature);
                updateElement('battery-soc-value', data.battery.soc);
                
                const soc = data.battery.soc || 0;
                const socBar = document.getElementById('battery-soc-bar');
                const socText = document.getElementById('battery-soc-text');
                if (socBar) {
                    socBar.style.width = soc + '%';
                    socText.textContent = soc.toFixed(1) + '%';
                }
            }

            // Update motor data
            if (data.motor) {
                updateElement('motor-speed', data.motor.speed);
                updateElement('motor-torque', data.motor.torque);
                updateElement('motor-temperature', data.motor.temperature);
            }

            // Update charging data
            if (data.charging) {
                updateElement('charger-voltage', data.charging.voltage);
                updateElement('charger-current', data.charging.current);
                updateStateBadge('charger-state', data.charging.state);
            }

            // Update vehicle data
            if (data.vehicle) {
                updateStateBadge('vehicle-state', data.vehicle.state);
            }

            // Update temperature sensor data
            if (data.temperature) {
                // Battery cell groups - show average or list
                // Warning: 40¬∞C, Fault: 50¬∞C (typical for battery cells)
                if (data.temperature.battery_cell_groups && data.temperature.battery_cell_groups.length > 0) {
                    const cellTemps = data.temperature.battery_cell_groups.filter(t => t !== null && t !== undefined);
                    if (cellTemps.length > 0) {
                        const avg = cellTemps.reduce((a, b) => a + b, 0) / cellTemps.length;
                        const min = Math.min(...cellTemps);
                        const max = Math.max(...cellTemps);
                        const displayValue = `${avg.toFixed(1)} (${min.toFixed(1)}-${max.toFixed(1)})`;
                        updateTemperatureRange('temp-battery-groups', displayValue, 40, 50);
                    } else {
                        updateElement('temp-battery-groups', '--');
                    }
                } else {
                    updateElement('temp-battery-groups', '--');
                }
                
                // Coolant temperatures
                // Warning: 60¬∞C, Fault: 90¬∞C
                if (data.temperature.coolant) {
                    updateTemperatureElement('temp-coolant-inlet', data.temperature.coolant.inlet, 60, 90);
                    updateTemperatureElement('temp-coolant-outlet', data.temperature.coolant.outlet, 60, 90);
                }
                
                // Motor stator temperatures - show average or list
                // Warning: 80¬∞C, Fault: 150¬∞C
                if (data.temperature.motor_stator && data.temperature.motor_stator.length > 0) {
                    const statorTemps = data.temperature.motor_stator.filter(t => t !== null && t !== undefined);
                    if (statorTemps.length > 0) {
                        const avg = statorTemps.reduce((a, b) => a + b, 0) / statorTemps.length;
                        const min = Math.min(...statorTemps);
                        const max = Math.max(...statorTemps);
                        const displayValue = `${avg.toFixed(1)} (${min.toFixed(1)}-${max.toFixed(1)})`;
                        updateTemperatureRange('temp-motor-stator', displayValue, 80, 150);
                    } else {
                        updateElement('temp-motor-stator', '--');
                    }
                } else {
                    updateElement('temp-motor-stator', '--');
                }
                
                // Charging temperatures
                // Warning: 60¬∞C, Fault: 100¬∞C
                if (data.temperature.charging) {
                    updateTemperatureElement('temp-charging-port', data.temperature.charging.port, 60, 100);
                    updateTemperatureElement('temp-charging-connector', data.temperature.charging.connector, 60, 100);
                }
            }

            // Update CAN stats
            if (data.can_stats) {
                updateElement('can-frames-sent', data.can_stats.frames_sent);
                updateElement('can-frames-received', data.can_stats.frames_received);
                updateElement('can-errors', data.can_stats.errors);
                updateElement('can-connected', data.can_stats.is_connected ? 'Yes' : 'No');
            }

            // Update timestamp
            if (data.timestamp) {
                const date = new Date(data.timestamp * 1000);
                document.getElementById('last-update').textContent = date.toLocaleTimeString();
            }
        });

        // Helper functions
        function updateElement(id, value) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.textContent = value;
            } else if (element) {
                element.textContent = '--';
            }
        }

        function updateStateBadge(id, state) {
            const element = document.getElementById(id);
            if (element && state) {
                element.textContent = state;
                element.className = 'state-badge state-' + state.toLowerCase();
            } else if (element) {
                element.textContent = '--';
                element.className = 'state-badge';
            }
        }

        function updateTemperatureElement(id, value, warningThreshold, faultThreshold) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.textContent = value;
                // Remove all temperature classes
                element.classList.remove('temp-normal', 'temp-warning', 'temp-fault');
                // Add appropriate class based on threshold
                if (faultThreshold && value >= faultThreshold) {
                    element.classList.add('temp-fault');
                } else if (warningThreshold && value >= warningThreshold) {
                    element.classList.add('temp-warning');
                } else {
                    element.classList.add('temp-normal');
                }
            } else if (element) {
                element.textContent = '--';
                element.classList.remove('temp-normal', 'temp-warning', 'temp-fault');
            }
        }

        function updateTemperatureRange(id, value, warningThreshold, faultThreshold) {
            const element = document.getElementById(id);
            if (element && value !== undefined && value !== null) {
                element.textContent = value;
                // For range values, check the max part (after the dash)
                const parts = value.split('(');
                if (parts.length > 1) {
                    const rangePart = parts[1].split('-')[1];
                    if (rangePart) {
                        const maxTemp = parseFloat(rangePart.split(')')[0]);
                        element.classList.remove('temp-normal', 'temp-warning', 'temp-fault');
                        if (faultThreshold && maxTemp >= faultThreshold) {
                            element.classList.add('temp-fault');
                        } else if (warningThreshold && maxTemp >= warningThreshold) {
                            element.classList.add('temp-warning');
                        } else {
                            element.classList.add('temp-normal');
                        }
                    }
                }
            } else if (element) {
                element.textContent = '--';
                element.classList.remove('temp-normal', 'temp-warning', 'temp-fault');
            }
        }

        // Request initial data
        socket.emit('request_update');

        // Request updates periodically as backup
        setInterval(() => {
            socket.emit('request_update');
        }, 5000);
    </script>
</body>
</html>

